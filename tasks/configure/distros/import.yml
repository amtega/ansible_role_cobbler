---
# Import distros

- block:
    - name: import distros artifacts
      command: >-
        cobbler import
        --name={{ cobbler_distro_name }}
        --path={{ cobbler_iso_mount_dir }}/{{ cobbler_iso_file | basename }}
      when: >
        cobbler_distros
        | selectattr('artifact.file', 'equalto', cobbler_iso_file | basename)
        | map(attribute='name')
        | list
        | first
        not in cobbler_saved_isos
      register: cobbler_import_result
      loop: >-
        {{ cobbler_search_iso_files_result.files
           | map(attribute="path")
           | list }}
      loop_control:
        loop_var: cobbler_iso_file
        label: "{{ cobbler_iso_file | basename }}"

    - name: add ksmeta attributes to distros config
      command: >-
        cobbler distro edit
        --name={{ cobbler_distro_name }}
        --ksmeta='iso_file={{ cobbler_distro_file }}
                  iso_checksum={{ cobbler_distro_iso_ckecksum }}'
      when: cobbler_import_result.results[cobbler_iso_file_index] is changed
      loop: >-
        {{ cobbler_search_iso_files_result.files
           | map(attribute="path")
           | list }}
      loop_control:
        loop_var: cobbler_iso_file
        index_var: cobbler_iso_file_index
        label: "{{ cobbler_iso_file | basename }}"

    - name: delete default profile created during distro import
      command: >-
        cobbler profile remove
        --name={{ cobbler_distro_name }}
        --recursive
      when: cobbler_import_result.results[cobbler_iso_file_index] is changed
      loop: >-
        {{ cobbler_search_iso_files_result.files
           | map(attribute="path")
           | list }}
      loop_control:
        loop_var: cobbler_iso_file
        index_var: cobbler_iso_file_index
        label: "{{ cobbler_iso_file | basename }}"
  vars:
    cobbler_matched_distros: >-
      {{ cobbler_distros
         | selectattr('artifact.file',
                      'equalto',
                      cobbler_iso_file | basename) }}

    cobbler_distro_name: >-
      {{ cobbler_matched_distros
         | map(attribute='name')
         | list
         | first }}

    cobbler_distro_file: >-
      {{ cobbler_matched_distros
         | map(attribute='artifact.file')
         | list
         | first }}

    cobbler_artifact_result_fact: >-
      artifact_result_cobbler_{{ cobbler_distro.name
                 | regex_replace(" ", "")
                 | regex_replace("-", "_") }}

    cobbler_distro_iso_ckecksum: >-
      {{ cobbler_download_isos_result[cobbler_artifact_result_fact].checksum }}
  tags:
    - role::cobbler
    - role::cobbler::configure
    - role::cobbler::configure::distros
